
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Rules for user-specific data and company profiles
    match /companyProfiles/{companyId} {
      // The owner of the company profile can read and write to it.
      allow read, write: if request.auth.uid == companyId;

      // The owner can also read and write to all subcollections.
      // This recursive wildcard is crucial for accessing invoices, materials, etc.
      match /{subcollection}/{docId=**} {
        allow read, write: if request.auth.uid == companyId;
      }
    }
    
    // Rules for user mappings, to link collaborators to admins
    match /userMappings/{userId} {
      // Any authenticated user can read mappings (to find their admin).
      // An authenticated user (the admin) can create a mapping for a new collaborator.
      allow read, write: if request.auth != null;
    }
  }
}
